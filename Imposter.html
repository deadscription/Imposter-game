<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Imposter Game</title>
  <style>
    #numberButtons button.available { background-color: #8BC34A; color: white; margin: 5px; padding: 10px; }
    #numberButtons button.taken { background-color: #B0BEC5; color: white; margin: 5px; padding: 10px; }
    #wordBox { display: none; margin-top: 20px; font-size: 1.5em; }
  </style>
</head>
<body>
  <h1>Imposter Game</h1>
  <div id="numberButtons"></div>
  <div id="wordBox"></div>
  <button id="newRoundBtn">Start New Round</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
  // ---------------- Firebase config ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyDvpa6IP-gjyVVg_lFizwMNjflqbJMw2uQ",
    authDomain: "imposter-game-515d8.firebaseapp.com",
    databaseURL: "https://imposter-game-515d8-default-rtdb.firebaseio.com",
    projectId: "imposter-game-515d8",
    storageBucket: "imposter-game-515d8.firebasestorage.app",
    messagingSenderId: "727642877069",
    appId: "1:727642877069:web:35f0113718fdde270b06c4"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ----------------- Auth & Health Check -----------------
  firebase.auth().signInAnonymously()
    .then(() => {
      console.log("‚úÖ Anonymous sign-in successful");
      // quick write/read test
      const testRef = db.ref("healthCheck/test");
      testRef.set({ timestamp: Date.now() })
        .then(() => testRef.once("value"))
        .then(snapshot => {
          console.log("‚úÖ Database test passed, starting game!");
          startGame(); // initial game start
        })
        .catch(err => {
          console.error("‚ùå Database test failed:", err);
          alert("Database access failed. Check Firebase rules.");
        });
    })
    .catch(err => {
      console.error("‚ùå Auth failed:", err);
      alert("Firebase sign-in failed. Check console.");
    });

  // ----------------- Game Logic -----------------
  function startGame(seedFromParam = null) {
    const secretWords = ["pizza","moon","guitar","jungle","volcano","camera","robot","beach","pyramid","penguin","castle","carrot","mountain","computer","ocean"];
    const params = new URLSearchParams(window.location.search);
    let seed = seedFromParam || params.get("seed");
    if(!seed){
      seed = Math.floor(Math.random()*1000000);
      window.history.replaceState({}, "", "?seed=" + seed);
    }

    function seededRandom(seed){ const x = Math.sin(seed++)*10000; return x - Math.floor(x); }
    const wordIndex = Math.floor(seededRandom(seed) * secretWords.length);
    const imposterIndex = Math.floor(seededRandom(seed * 7) * 7);
    const chosenWord = secretWords[wordIndex];

    const gameRef = db.ref("games/" + seed + "/players");
    const numberButtonsDiv = document.getElementById("numberButtons");

    // Create player buttons
    numberButtonsDiv.innerHTML = ""; // clear previous
    for(let i=0;i<7;i++){
      const btn = document.createElement("button");
      btn.textContent = i + 1;
      btn.classList.add("available");
      btn.disabled = false;
      btn.addEventListener("click", ()=>{
        gameRef.child(i).set(true);
        displayWord(i, btn);
      });
      numberButtonsDiv.appendChild(btn);
    }

    // Sync live updates
    gameRef.on("value", snapshot=>{
      const data = snapshot.val() || {};
      for(let i=0;i<7;i++){
        const btn = numberButtonsDiv.children[i];
        if(data[i]){
          btn.classList.remove("available");
          btn.classList.add("taken");
          btn.disabled = true;
        } else {
          btn.classList.add("available");
          btn.classList.remove("taken");
          btn.disabled = false;
        }
      }
    });

    // Show player's word/imposter
    function displayWord(i, btn){
      const wordBox = document.getElementById("wordBox");
      if(i === imposterIndex){
        wordBox.innerHTML = "‚ùó You are the Imposter!";
      } else {
        wordBox.innerHTML = "üóùÔ∏è Your word is: <b>" + chosenWord + "</b>";
      }
      wordBox.style.display = "block";
    }

    // Start New Round
    document.getElementById("newRoundBtn").onclick = () => {
      const newSeed = Math.floor(Math.random() * 1000000);
      const newURL = window.location.origin + window.location.pathname + "?seed=" + newSeed;
      window.history.pushState({}, "", newURL);

      // Clear previous game
      document.getElementById("numberButtons").innerHTML = "";
      document.getElementById("wordBox").style.display = "none";

      // Start a fresh round
      startGame(newSeed);
    };
  }
  </script>
</body>
</html>
